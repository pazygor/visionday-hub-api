// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Empresa {
  id               Int         @id @default(autoincrement()) @map("id")
  cnpj             String      @db.VarChar(14) @map("cnpj")
  razaoSocial      String      @map("razao_social")
  cidade           String      @map("cidade")
  uf               String      @db.VarChar(2) @map("uf")
  endereco         String      @map("endereco")
  bairro           String      @map("bairro")
  cep              String      @map("cep")
  dataAdesao       DateTime    @db.Date @map("data_adesao")
  horaAdesao       DateTime    @db.Time(0) @map("hora_adesao")
  tenant           String      @map("tenant")
  limiteProjetos   Int         @default(0) @map("limite_projetos")
  limiteServidores Int         @default(0) @map("limite_servidores")

  usuarios   Usuario[] @relation("EmpresaUsuarios")
  projetos   Projeto[] @relation("EmpresaProjetos")
  servidores Servidor[] @relation("EmpresaServidores")
  produtos EmpresaProduto[]
  monitoramentos Monitoramento[]
  alertasParametros AlertaParametro[]
  @@map("empresa")
}

model Projeto {
  id                  Int        @id @default(autoincrement()) @map("id")
  nome                String     @map("nome")
  env                 String     @map("env")
  tenant              String     @map("tenant")
  dataInicio          DateTime   @map("data_inicio")
  status              String     @map("status")
  localArmazenamento  String     @map("local_armazenamento") // ✅ Adicionado aqui
  empresaId           Int?       @map("empresa_id")
  empresa             Empresa?   @relation("EmpresaProjetos", fields: [empresaId], references: [id], onDelete: Cascade)

  servidores Servidor[] @relation("ProjetoServidores")


  @@map("projeto")
}

model Servidor {
  id                   Int           @id @default(autoincrement()) @map("id")
  nome                 String        @map("nome")
  ip                   String        @map("ip")
  tipo                 String        @map("tipo")
  sistemaOperacional   String        @map("sistema_operacional")
  status               String        @map("status")
  createdAt            DateTime      @default(now()) @map("created_at")
  projetoId            Int           @map("projeto_id")
  projeto              Projeto       @relation("ProjetoServidores", fields: [projetoId], references: [id], onDelete: Cascade)
  empresaId            Int           @map("empresa_id")
  empresa              Empresa       @relation("EmpresaServidores", fields: [empresaId], references: [id], onDelete: Cascade)

  // Novo relacionamento com AlertaParametro
  parametrosAlerta     AlertaParametro[] // Um servidor pode ter vários parâmetros de alerta
  usuariosAlerta  AlertaUsuario[]        @relation("ServidorAlertaUsuario")

  @@map("servidor")
}

model Usuario {
  id             Int               @id @default(autoincrement()) @map("id")
  empresaId      Int               @map("empresa")
  nome           String            @map("nome")
  senha          String            @map("senha")
  email          String            @unique @map("email")
  imagem         String?           @map("imagem")
  permissao      Int?              @map("permissao")
  updatedAt      DateTime          @default(now()) @updatedAt @map("updated_at")
  createdAt      DateTime          @default(now()) @map("created_at")
  token          String?           @map("token")
  ativo          Boolean           @default(true) @map("ativo")
  loginAtivo     Boolean?          @map("login_ativo")
  motivo         String?           @map("motivo")
  validade       DateTime?         @map("validade")
  perfil         Int?              @map("perfil")
  celular        String?           @map("celular")
  cadastro       Int?              @map("cadastro")

  empresa        Empresa           @relation("EmpresaUsuarios", fields: [empresaId], references: [id])
  grupoUsuarios  GrupoUsuario[]    @relation("GrupoUsuarios")

  @@map("usuarios")
}
model Grupo {
  id          Int              @id @default(autoincrement()) @map("id")
  nome        String           @map("nome")
  descricao   String?          @map("descricao")
  usuarios    GrupoUsuario[]   @relation("GrupoUsuarios")
  alertas     GrupoAlerta[]    @relation("GrupoAlertas")

  @@map("grupo")
}

model GrupoUsuario {
  id        Int      @id @default(autoincrement()) @map("id")
  usuarioId Int      @map("usuario_id")
  grupoId   Int      @map("grupo_id")
  usuario   Usuario  @relation("GrupoUsuarios", fields: [usuarioId], references: [id], onDelete: Cascade)
  grupo     Grupo    @relation("GrupoUsuarios", fields: [grupoId], references: [id], onDelete: Cascade)

  @@map("grupo_usuario")
}

model GrupoAlerta {
  id             Int           @id @default(autoincrement()) @map("id")
  grupoId        Int           @map("grupo_id")
  grupo          Grupo         @relation("GrupoAlertas", fields: [grupoId], references: [id], onDelete: Cascade)

  @@map("grupo_alerta")
}

model AlertaParametro {
  id              Int          @id @default(autoincrement()) @map("id")
  serverId        Int          @map("server_id")
  empresaId       Int          @map("empresa_id")
  metricasId      Int          @map("metricas_id")
  criticidadeId   Int          @map("criticidade_id")
  nomeCampo       String       @map("nome_campo")
  valor           Float        @map("valor")
  type            String       @map("type") // 'app' ou 'infra'
  unidadeValor    String       @map("unidade_valor")
  tenant          String       @map("tenant")
  env             String       @map("env")
  ip              String       @map("ip")

  // Relações
  servidor        Servidor     @relation(fields: [serverId], references: [id], onDelete: Cascade)
  empresa         Empresa      @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  metrica         Metrica      @relation(fields: [metricasId], references: [id], onDelete: Cascade)
  criticidade     Criticidade  @relation(fields: [criticidadeId], references: [id], onDelete: Cascade)

  @@map("alerta_parametros")
}

model AlertaUsuario {
  id           Int       @id @default(autoincrement())
  servidorId   Int
  contato      String    // Email ou Telefone
  grupo        String    // Ex: 'Infraestrutura', 'Aplicações', 'Banco de Dados', 'Geral'
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  servidor     Servidor  @relation("ServidorAlertaUsuario", fields: [servidorId], references: [id], onDelete: Cascade)
  

  @@map("alerta_usuario")
}

model Produto {
  id            Int            @id @default(autoincrement())
  nome_produto  String
  status        String         @default("ativo") // ativo, inativo, etc.
  empresas      EmpresaProduto[]
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  @@map("produto")
}

model EmpresaProduto {
  id          Int       @id @default(autoincrement())
  empresa_id  Int
  produto_id  Int
  status      String    @default("ativo") // ativo, suspenso, cancelado...
  contratado_em DateTime @default(now())

  empresa     Empresa   @relation(fields: [empresa_id], references: [id])
  produto     Produto   @relation(fields: [produto_id], references: [id])

  @@unique([empresa_id, produto_id]) // uma empresa não pode ter o mesmo produto repetido
  @@map("empresa_produto")
}

model Monitoramento {
  id                Int      @id @default(autoincrement())
  empresa_id        Int
  nome_monitoramento String
  produto           String   // SVS Monitor ou SVS Insights
  projetos          Json     // [{ id: 1, nome: "Projeto A" }, ...]
  servidores        Json     // [{ id: 1, nome: "Servidor A", projetoId: 1 }, ...]
  status            String   @default("ativo")
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relacionamento (exemplo, ajuste se usa outro nome)
  empresa           Empresa  @relation(fields: [empresa_id], references: [id])
  @@map("monitoramento")
} 
model Metrica {
  id               Int                @id @default(autoincrement()) @map("id")
  nome             String            @map("nome")

  parametros       AlertaParametro[] // relação reversa
  @@map("metricas")
}

model Criticidade {
  id               Int                @id @map("id") // Remova o @default(autoincrement())
  nome             String            @map("nome")

  parametros       AlertaParametro[] // relação reversa
  @@map("criticidade")
}