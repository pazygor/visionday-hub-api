// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Empresa {
  id               Int         @id @default(autoincrement()) @map("id")
  cnpj             String      @db.VarChar(14) @map("cnpj")
  razaoSocial      String      @map("razao_social")
  cidade           String      @map("cidade")
  uf               String      @db.VarChar(2) @map("uf")
  endereco         String      @map("endereco")
  bairro           String      @map("bairro")
  cep              String      @map("cep")
  dataAdesao       DateTime    @db.Date @map("data_adesao")
  horaAdesao       DateTime    @db.Time(0) @map("hora_adesao")
  tenant           String      @map("tenant")
  limiteProjetos   Int         @default(0) @map("limite_projetos")
  limiteServidores Int         @default(0) @map("limite_servidores")

  usuarios   Usuario[] @relation("EmpresaUsuarios")
  projetos   Projeto[] @relation("EmpresaProjetos")
  servidores Servidor[] @relation("EmpresaServidores")
  produtosSistemas       EmpresaProdutoSistema[]  
  produtos EmpresaProduto[]
  monitoramentos Monitoramento[]
  alertasParametros AlertaParametro[]
  operadoresDeploy DP0[]       @relation("EmpresaDP0") // <- adicionando relaÃ§Ã£o com DP0
  operadorcoesDeploy DP1[]       @relation("EmpresaDP1") // <- adicionando relaÃ§Ã£o com DP1
  tarefasDeploy DP2[]       @relation("EmpresaDP2") // <- adicionando relaÃ§Ã£o com DP2
  serversDeploy DP3[]       @relation("EmpresaDP3") // <- adicionando relaÃ§Ã£o com DP3
  @@map("empresa")
}

model Projeto {
  id                  Int        @id @default(autoincrement()) @map("id")
  nome                String     @map("nome")
  env                 String     @map("env")
  tenant              String     @map("tenant")
  dataInicio          DateTime   @map("data_inicio")
  status              String     @map("status")
  localArmazenamento  String     @map("local_armazenamento") // âœ… Adicionado aqui
  empresaId           Int?       @map("empresa_id")
  empresa             Empresa?   @relation("EmpresaProjetos", fields: [empresaId], references: [id], onDelete: Cascade)
  monitoramentoProtheus Boolean @default(false) @map("monitoramento_protheus")

  servidores Servidor[] @relation("ProjetoServidores")


  @@map("projeto")
}

model Servidor {
  id                   Int           @id @default(autoincrement()) @map("id")
  nome                 String        @map("nome")
  ip                   String        @map("ip")
  tipo                 String        @map("tipo")
  sistemaOperacional   String        @map("sistema_operacional")
  status               String        @map("status")
  createdAt            DateTime      @default(now()) @map("created_at")
  projetoId            Int           @map("projeto_id")
  projeto              Projeto       @relation("ProjetoServidores", fields: [projetoId], references: [id], onDelete: Cascade)
  empresaId            Int           @map("empresa_id")
  empresa              Empresa       @relation("EmpresaServidores", fields: [empresaId], references: [id], onDelete: Cascade)
  nomeUsuario          String?        @map("nome_usuario")
  senhaUsuario         String?        @map("senha_usuario")
  sudo               Boolean    @default(false) @map("sudo")
  // Novo campo para environments e portas
  data                 Json?            @map("data")

  // Novo relacionamento com AlertaParametro
  parametrosAlerta     AlertaParametro[] // Um servidor pode ter vÃ¡rios parÃ¢metros de alerta
  usuariosAlerta  AlertaUsuario[]        @relation("ServidorAlertaUsuario")

  @@map("servidor")
}

model Usuario {
  id             Int                     @id @default(autoincrement()) @map("id")
  empresaId      Int                     @map("empresa")
  nome           String                  @map("nome")
  senha          String                  @map("senha")
  email          String                  @unique @map("email")
  imagem         String?                 @map("imagem")
  permissaoId    Int                     @map("permissao")
  permissao      Permissao               @relation("PermissaoUsuarios", fields: [permissaoId], references: [id])
  updatedAt      DateTime                @default(now()) @updatedAt @map("updated_at")
  createdAt      DateTime                @default(now()) @map("created_at")
  token          String?                 @map("token")
  ativo          Boolean                 @default(true) @map("ativo")
  loginAtivo     Boolean?                @map("login_ativo")
  motivo         String?                 @map("motivo")
  validade       DateTime?               @map("validade")
  perfil         Int?                    @map("perfil")
  celular        String?                 @map("celular")
  cadastro       Int?                    @map("cadastro")
  account        String?                 @map("account")
  emailLanguage  String?                 @map("email_language")
  appLanguage    String?                 @map("app_language")
  country        String?                 @map("country")
  autoProjectCreation Boolean?           @map("auto_project_creation")
  throughPutUnit      String?            @map("through_put_unit")

  empresa        Empresa                 @relation("EmpresaUsuarios", fields: [empresaId], references: [id])
  grupoUsuarios  GrupoUsuario[]          @relation("GrupoUsuarios")
  usuarioProdutos UsuarioProduto[]       // RelaÃ§Ã£o com os produtos permitidos
  usuarioProdutoSistemas UsuarioProdutoSistema[] @relation("UsuarioToProdutoSistema")
  dp0Users       DP0[]                   @relation("UsuarioDP0") // relaÃ§Ã£o reversa opcional

  @@map("usuarios")
}
model UsuarioProduto {
  id         Int      @id @default(autoincrement())
  usuarioId  Int
  produtoId  Int
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  produto    Produto  @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, produtoId])
  @@map("usuario_produto")
}
model UsuarioProdutoSistema {
  id               Int               @id @default(autoincrement())
  usuarioId        Int
  produtoSistemaId Int

  usuario         Usuario         @relation("UsuarioToProdutoSistema", fields: [usuarioId], references: [id], onDelete: Cascade)
  produtoSistema  ProdutoSistema  @relation("ProdutoSistemaToUsuario", fields: [produtoSistemaId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, produtoSistemaId])
  @@map("usuario_produto_sistema")
}
model Permissao {
  id        Int       @id @default(autoincrement())
  nome      String    @unique              // Ex: admin_global, admin_cliente, usuario, viewer
  descricao String?

  usuarios  Usuario[] @relation("PermissaoUsuarios")
  operadoresDP0 DP0[] // <- nova relaÃ§Ã£o com a tabela DP0

  @@map("permissao")
}
model Grupo {
  id          Int              @id @default(autoincrement()) @map("id")
  nome        String           @map("nome")
  descricao   String?          @map("descricao")
  usuarios    GrupoUsuario[]   @relation("GrupoUsuarios")
  alertas     GrupoAlerta[]    @relation("GrupoAlertas")

  @@map("grupo")
}

model GrupoUsuario {
  id        Int      @id @default(autoincrement()) @map("id")
  usuarioId Int      @map("usuario_id")
  grupoId   Int      @map("grupo_id")
  usuario   Usuario  @relation("GrupoUsuarios", fields: [usuarioId], references: [id], onDelete: Cascade)
  grupo     Grupo    @relation("GrupoUsuarios", fields: [grupoId], references: [id], onDelete: Cascade)

  @@map("grupo_usuario")
}

model GrupoAlerta {
  id             Int           @id @default(autoincrement()) @map("id")
  grupoId        Int           @map("grupo_id")
  grupo          Grupo         @relation("GrupoAlertas", fields: [grupoId], references: [id], onDelete: Cascade)

  @@map("grupo_alerta")
}

model AlertaParametro {
  id              Int          @id @default(autoincrement()) @map("id")
  serverId        Int          @map("server_id")
  empresaId       Int          @map("empresa_id")
  metricasId      Int          @map("metricas_id")
  criticidadeId   Int          @map("criticidade_id")
  nomeCampo       String       @map("nome_campo")
  valor           Float        @map("valor")
  type            String       @map("type") // 'app' ou 'infra'
  unidadeValor    String       @map("unidade_valor")
  tenant          String       @map("tenant")
  env             String       @map("env")
  ip              String       @map("ip")

  // RelaÃ§Ãµes
  servidor        Servidor     @relation(fields: [serverId], references: [id], onDelete: Cascade)
  empresa         Empresa      @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  metrica         Metrica      @relation(fields: [metricasId], references: [id], onDelete: Cascade)
  criticidade     Criticidade  @relation(fields: [criticidadeId], references: [id], onDelete: Cascade)

  @@map("alerta_parametros")
}

model AlertaUsuario {
  id           Int       @id @default(autoincrement())
  servidorId   Int
  contato      String    // Email ou Telefone
  grupo        String    // Ex: 'Infraestrutura', 'AplicaÃ§Ãµes', 'Banco de Dados', 'Geral'
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  servidor     Servidor  @relation("ServidorAlertaUsuario", fields: [servidorId], references: [id], onDelete: Cascade)
  

  @@map("alerta_usuario")
}

model ProdutoSistema {
  id                       Int                      @id @default(autoincrement())
  nome                     String                   @unique
  produtos                 Produto[]
  usuarioProdutoSistemas   UsuarioProdutoSistema[] @relation("ProdutoSistemaToUsuario")
  empresas               EmpresaProdutoSistema[]  
  @@map("produto_sistema")
}

model Produto {
  id               Int               @id @default(autoincrement())
  nome_produto     String
  status           String            @default("ativo") // ativo, inativo
  sistema_id       Int               // Chave estrangeira para ProdutoSistema
  sistema          ProdutoSistema    @relation(fields: [sistema_id], references: [id])
  empresas         EmpresaProduto[]  // Empresas que contrataram este produto
  usuarioProdutos UsuarioProduto[] // ðŸ‘ˆ Adicione esta linha
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  @@map("produto")
}

model EmpresaProduto {
  id          Int       @id @default(autoincrement())
  empresa_id  Int
  produto_id  Int
  status      String    @default("ativo") // ativo, suspenso, cancelado...
  contratado_em DateTime @default(now())

  empresa     Empresa   @relation(fields: [empresa_id], references: [id])
  produto     Produto   @relation(fields: [produto_id], references: [id])

  @@unique([empresa_id, produto_id]) // uma empresa nÃ£o pode ter o mesmo produto repetido
  @@map("empresa_produto")
}
model EmpresaProdutoSistema {
  id               Int               @id @default(autoincrement())
  empresaId        Int
  produtoSistemaId Int

  empresa          Empresa           @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  produtoSistema   ProdutoSistema    @relation(fields: [produtoSistemaId], references: [id], onDelete: Cascade)

  @@unique([empresaId, produtoSistemaId])
  @@map("empresa_produto_sistema")
}
model Monitoramento {
  id                Int      @id @default(autoincrement())
  empresa_id        Int
  nome_monitoramento String
  produto           String   // SVS Monitor ou SVS Insights
  projetos          Json     // [{ id: 1, nome: "Projeto A" }, ...]
  servidores        Json     // [{ id: 1, nome: "Servidor A", projetoId: 1 }, ...]
  status            String   @default("ativo")
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  url_download      String?   @db.Text 
  
  // Relacionamento (exemplo, ajuste se usa outro nome)
  empresa           Empresa  @relation(fields: [empresa_id], references: [id])
  @@map("monitoramento")
} 
model Metrica {
  id               Int                @id @default(autoincrement()) @map("id")
  nome             String            @map("nome")

  parametros       AlertaParametro[] // relaÃ§Ã£o reversa
  @@map("metricas")
}

model Criticidade {
  id               Int                @id @map("id") // Remova o @default(autoincrement())
  nome             String            @map("nome")

  parametros       AlertaParametro[] // relaÃ§Ã£o reversa
  @@map("criticidade")
}
model DP0 {
  id          Int       @id @default(autoincrement()) @map("dp0_codope") // CÃ³digo do operador
  empresaId   Int       @map("empresa_id")
  oper        String    @map("dp0_oper")     // nome do operador
  email       String    @map("dp0_email")      // email do operador
  senha       String    @map("dp0_senha")      // senha do operador
  permissaoId Int       @map("dp0_permissao")                // FK para permissÃµes
  grants      String    @map("dp0_grants")   // permissÃµes extras (se precisar)
  usergi      String?    @map("dp0_usergi")   // log inclusÃ£o
  userga      String?    @map("dp0_userga")   // log alteraÃ§Ã£o
  usuarioId   Int?      @map("usuario_id") // FK para tabela usuario
  // RelaÃ§Ãµes
  empresa     Empresa   @relation("EmpresaDP0", fields: [empresaId], references: [id], onDelete: Cascade)
  permissao   Permissao @relation(fields: [permissaoId], references: [id])
  usuario     Usuario?  @relation("UsuarioDP0", fields: [usuarioId], references: [id])

  @@map("dp0")
}
model DP1 {
  id          Int       @id @default(autoincrement()) @map("dp1_codope") // CÃ³digo da operaÃ§Ã£o
  empresaId   Int       @map("empresa_id")
  oper        String    @map("dp1_oper")     // nome da operadoraÃ§Ã£o
  usergi      String?    @map("dp1_usergi")   // log inclusÃ£o
  userga      String?    @map("dp1_userga")   // log alteraÃ§Ã£o

  // RelaÃ§Ãµes
  empresa     Empresa   @relation("EmpresaDP1", fields: [empresaId], references: [id], onDelete: Cascade)

  @@map("dp1")
}

model DP2 {
  codtsk    Int      @map("dp2_codtsk")       // CÃ³digo da tarefa (10, 20, 30â€¦)
  empresaId Int      @map("empresa_id")       // FK para empresa
  task      String   @map("dp2_task")
  tag       String?  @map("dp2_tag")
  usergi    String?  @map("dp2_usergi")
  userga    String?  @map("dp2_userga")

  empresa   Empresa  @relation("EmpresaDP2", fields: [empresaId], references: [id], onDelete: Cascade)

  @@id([empresaId, codtsk]) // <-- chave composta
  @@map("dp2")
}

model DP3 {
  codent    Int      @id @default(autoincrement()) @map("dp3_codent") // CÃ³digo do agente (auto_increment)
  empresaId Int      @map("empresa_id")                              // FK para empresa
  nome      String   @map("dp3_nome")                // Nome do agente
  ipsvs     String?  @map("dp3_ipsvs")               // IP do Server SVS
  porta     String?  @map("dp3_porta")                // Porta do Server SVS
  usergi    String?  @map("dp3_usergi")              // Log de inclusÃ£o
  userga    String?  @map("dp3_userga")              // Log de alteraÃ§Ã£o

  // RelaÃ§Ã£o com Empresa
  empresa   Empresa  @relation("EmpresaDP3", fields: [empresaId], references: [id], onDelete: Cascade)

  @@map("dp3")
}
